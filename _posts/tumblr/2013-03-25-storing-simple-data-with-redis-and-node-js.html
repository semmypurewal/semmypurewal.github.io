---
layout: post
title: Storing Simple Data with Redis and Node.js
date: '2013-03-25T09:12:00-07:00'
tags: []
tumblr_url: http://blog.semmy.me/post/46247962979/storing-simple-data-with-redis-and-node-js
---
<p>In my previous two blog posts, we <a target="_blank" href="http://blog.semmy.me/2013/03/17/vagrant-1-1-0-and-node-dev-bootstrap.html">set up a Node.js development environment</a> using Vagrant and Chef, and then we <a target="_blank" href="http://blog.semmy.me/2012/02/10/streaming-twitter-with-ntwitter-and-node-js.html">used the ntwitter module to connect to Twitter&#8217;s streaming API</a>. Next, we&#8217;d like to store some information on the server that will remain even after the server shuts down, and then we&#8217;d like to display this information to the user. In this post, we&#8217;re going to focus on the former: we&#8217;ll write some code that keeps track some aggregate information about the tweets using <a target="_blank" href="http://redis.io">Redis</a>. I&#8217;ll assume you&#8217;ve worked your way through the previous two tutorials.</p>

<p>Redis is a key-value store; some refer to it as a data-structure server. These are different from traditional databases in that they store information in volatile memory (keeping it very fast)  and also allow you to organize data into traditional structures (hashes, lists, sets, etc). It is perfect for storing data that needs to be accessed quickly (like session information) or for caching to improve the response time of your applications.</p>

<p>Our goal is to keep track of the number of times each of the following words appear: &#8216;awesome,&#8217; &#8216;cool,&#8217; &#8216;rad,&#8217; &#8216;gnarly,&#8217; and &#8216;groovy.&#8217; To do this, we&#8217;ll simply use a key for each of the words, and each value will be an integer representing the number of times the word appears.</p>

<p>To get a feeling for how redis works, let&#8217;s interact with it via the command line client. Fire up vagrant and ssh into the box.</p>

<pre class="code">
$ vagrant up
$ vagrant ssh
</pre>

<p>Now we should be logged into our virtual machine where redis is already installed and configured. The following command starts up the redis client and creates a key for &#8216;awesome&#8217; and sets its value to 0.</p>

<pre class="code">
$ redis-cli
redis 127.0.0.1:6379&gt; set awesome 0
</pre>

<p>If all goes well, redis should respond with &#8216;OK.&#8217; We can check the value of the key by using the <tt>get</tt> command, and we can increment it by using the <tt>incr</tt> command.</p>

<pre class="code">
redis 127.0.0.1:6379&gt; get awesome
"0"
redis 127.0.0.1:6379&gt; incr awesome
(integer) 1
redis 127.0.0.1:6379&gt; incr awesome
(integer) 2
redis 127.0.0.1:6379&gt; get awesome
"2"
</pre>

<p>To exit out of the interactive redis client, you can type &#8216;exit&#8217; or press CTRL-D to send an End-Of-File character to the process. If you want to practice and learn more about redis, try out this outstanding <a target="_blank" href="http://try.redis-db.com/">interactive redis tutorial</a>.</p>

<p>So now we know how to create a key for each word and then increment the value interactively, but we&#8217;d like to be able to do it programmatically in Node. To do this, we&#8217;ll need to install the redis module via npm.</p>

<p>Previously, we had used npm from the command line to install the ntwitter module. This makes sense when just starting out, but as we move forward it&#8217;s going to make sense to track our dependencies in a more formal way. To do this, we use a special file called package.json, which keeps track of some meta-information about our project.</p>

<p>In your app directory create a new file called package.json, and copy/paste the content below.</p>

<pre class="code">{
    "name": "tutorial",
    "description": "a tutorial on using node, twitter, redis, and express",
    "version": "0.0.1",
    "dependencies": {
        "ntwitter": "0.5.x",
        "redis": "0.8.x"
    }
}</pre>

<p>As you can see, this specifies some basic meta-information about your project, including the dependencies. Using this instead of installing your modules by hand has two advantages. The first is that we can now install all dependencies by simply typing the following command on your vagrant virtual machine.</p>

<pre class="code">
$ cd app
$ npm install --no-bin-links
</pre>

<p>The second is that it allows us to keep our node_modules directory (which contains all of our dependencies) out of our git repository. So now we can open up the .gitignore file that we created in the previous tutorial and modify it to look like this:</p>

<pre class="code">
credentials.js
node_modules
</pre>

<p>Once that&#8217;s finished, let&#8217;s go ahead and make a commit to our git repository so that we&#8217;ll have a clean working directory.</p>

<pre class="code">
$ git add package.json
$ git add .gitignore
$ git commit -m "add package.json and ignore node_modules directory"
</pre>

<p>Next, on your host machine, open the twitter.js file that we created in the last tutorial. It should be in the app directory, and you can open it in any text editor you&#8217;d like. Modify it so it looks like this:</p>

<pre class="code">var twitter = require('ntwitter');
var redis = require('redis');
var credentials = require('./credentials.js');

//create redis client                                                                                                                                                                                                                       
var client = redis.createClient();

var t = new twitter({
    consumer_key: credentials.consumer_key,
    consumer_secret: credentials.consumer_secret,
    access_token_key: credentials.access_token_key,
    access_token_secret: credentials.access_token_secret
});

t.stream(
    'statuses/filter',
    { track: ['awesome', 'cool', 'rad', 'gnarly', 'groovy'] },
    function(stream) {
        stream.on('data', function(tweet) {
            console.log(tweet.text);
            //if awesome is in the tweet text, increment the counter                                                                                                                                                                        
            if(tweet.text.indexOf("awesome") &gt; -1) {
                client.incr('awesome');
            }
        });
    }
);</pre>

<p>We can let this code run for a bit and this should keep track of the number of tweets containing the word &#8216;awesome&#8217; in Redis. We can verify this by stopping the program (with CTRL-C) and then reconnecting with the redis-cli program and getting the value of the &#8216;awesome&#8217; key. We can clear out the contents of Redis at any time by typing &#8220;flushall&#8221; at the redis-cli prompt.</p>

<p>We may also want to create a web server to show the awesome count if someone visits the server over http. This can be done by copying some of the code from our original server.js file that came with node-dev-bootstrap. First, we&#8217;ll have to require the node.js http module by including this line at the top of our file:</p>

<pre class="code">var http = require("http");</pre>

<p>Then, further down in the twitter worker code, we can create an HTTP server that responds to requests by copying the code from the original server.js file:</p>

<pre class="code">http.createServer(function (req, res) {
    res.writeHead(200, {"Content-Type": "text/plain"});
    res.end('Hello World!\n');
}).listen(3000);</pre>

<p>To have it respond by sharing the awesome count in redis, we&#8217;ll need to asynchronously request the data from the redis database. Modify this code so it looks like this:</p> 

<pre class="code">http.createServer(function (req, res) {
    client.get("awesome", function (error, awesomeCount) {
        if (error !== null) {
            //handle error here
            console.log("error: " + error);
        } else {
            res.writeHead(200, {"Content-Type": "text/plain"});
            res.end("The awesome count is " + awesomeCount);
        }
    });
}).listen(3000);</pre>

<p>The new lines in this program illustrate the non-blocking, event-driven nature of Node.js. If you’re coming from a more traditional programming background, you might be more comfortable with this approach to getting the value of the key:</p>

<pre class="code">var awesomeCount = client.get("awesome");</pre>

<p>In the first line of this code, note that the program halts until the Redis (or other DB) client returns the result of the query. So in any subsequent lines, we can use awesomeCount just like any other variable.</p>

<p>Node’s approach is different. It queries Redis, and while it’s waiting for the response, it continues executing the remainder of the program. That’s why we send in a function as a callback to the query — this tells Node what to do when Redis returns with an answer. The variables in our anonymous function take on the actual values when Redis returns; in part they act like the left hand side of the assignment operator in the blocking approach.</p>

<p>The error variable will be null if the result is successful; it will be set to an error object otherwise. That&#8217;s why we wrap the code in an <tt>if</tt> statement to check the status of the error object.</p>

<p>So our code to pull a key out of the redis database ends up looking something like this:</p>

<pre class="code">client.get("awesome", function (error, awesomeCount) {
    if (error !== null) {
        //handle error here
        console.log("error: " + error);
    } else {
        res.writeHead(200, {"Content-Type": "text/plain"});
        res.end("The awesome count is " + awesomeCount);
    } 
});</pre>

<p>Now you can run your twitter.js file by typing:</p>

<pre class="code">$ node twitter.js</pre>

<p>and you can visit the page in your web browser by typing localhost:3000 in the address bar.</p>

<p>You should now modify this code so it keeps track of the counts for all of the words that the ntwitter module is watching. This program will eventually become a background worker; my next blog post will show you how a better way to share these counts on a web page. We&#8217;ll use the <a href="http://expressjs.com/" target="_blank">Express</a> web framework to do this.</p>
