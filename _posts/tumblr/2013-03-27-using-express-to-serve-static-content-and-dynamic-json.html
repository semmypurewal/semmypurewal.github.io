---
layout: post
title: Using Express to Serve Static Content and Dynamic JSON
date: '2013-03-27T14:31:00-07:00'
tags: []
tumblr_url: http://blog.semmy.me/post/46435273508/using-express-to-serve-static-content-and-dynamic-json
---
<p>If you worked through the previous tutorials, I hope that you managed to <a target="_blank" href="http://blog.semmy.me/2013/03/17/vagrant-1-1-0-and-node-dev-bootstrap.html">create a basic node.js development environment using Vagrant</a>, <a target="_blank" href="http://blog.semmy.me/2012/02/10/streaming-twitter-with-ntwitter-and-node-js.html">stream data from twitter</a>, and, finally, <a target="_blank" href="http://blog.semmy.me/2013/03/25/storing-simple-data-with-redis-and-node-js.html">store aggregate information about that data in a Redis data store</a>. To get data from the Redis data store to the web browser, we used the http library to return a simple text page. So if you also completed the suggested exercise in the previous tutorial, your code might look something like this:</p>

<pre class="code">var server = http.createServer(function (req, res) {
    client.mget(["awesome","cool"], function(err, results) {
        if (err !== null) {
            //handle error here
            console.log("error: " + err);
        } else {
  	    var response = "&lt;b&gt;Hello from my http server!!&lt;/b&gt;";
	    response += "&lt;p&gt;Total awesome: " + results[0] + "&lt;/p&gt;";
	    response += "&lt;p&gt;Total cool: " + results[1] + "&lt;/p&gt;";
	    res.writeHead(200, {"Content-Type": "text/html"});
	    res.end(response);
        }
    });
}).listen(3000);</pre>

<p>Note that we used Redis’s mget command to send in an array of keys and get back an array of values. This isn’t something that I described in my previous blog posts, but it is described in the <a target="_blank" href="http://redis.io/documentation">Redis documentation</a>. If you continue to use Redis, it would be helpful to become familiar with some of the commands and data structures that Redis offers.</p>

<p>Now suppose we wanted to actually style this code and include some javascript. Notice how quickly this can add complexity to our callback function:</p>

<pre class="code"> var server = http.createServer(function (req, res) {
    client.mget(["awesome","cool"], function(err, results) {
        if (err !== null) {
            //handle error here
            console.log("error: " + err);
        } else {
            var response += "&lt;script&gt;";
            response += "//script stuff here";
            response += "&lt;/script&gt;";
            response += "&lt;style&gt;";
            response += "//style stuff here";
            response += "&lt;/style&gt;";
            response += "&lt;b&gt;Hello from my http server!!&lt;/b&gt; &lt;br/&gt;";
	    response += "&lt;p&gt;Total awesome: " + results[0] + "&lt;/p&gt;";
	    response += "&lt;p&gt;Total cool: " + results[1] + "&lt;/p&gt;";
            res.writeHead(200, {"Content-Type": "text/html"});
            res.end(response);
        }
    });
}).listen(3000); </pre>

<p>This is definitely an unsustainable approach. In fact, if you’re coming from an apache or rails background, this likely seems a little ridiculous. Does this mean we need to hard-code static html files as strings in our code?</p>

<p>That’s where the Express web framework comes in. <a href="http://">Express</a> is a web application framework for Node.js that is inspired by the <a href="http://">Sinatra</a> framework for Ruby. It creates a layer on top of the http library which provides these features among others. In this post, I’ll describe how to install express and create an Express application. Then I’ll talk a little bit about how to edit and create routes in your application.</p>

<p>Start by firing up your Vagrant virtual machine and ssh’ing into it. Next, you’ll want to add express to your package.json file. After adding it, your file should look something like this:</p>

<pre class="code">{
    "name": "tutorial",
    "description": "a tutorial on using node, twitter, redis, and express",
    "version": "0.0.1",
    "dependencies": {
	"express": "3.1.x",
        "ntwitter": "0.5.x",
        "redis": "0.8.x"
    }
}</pre>

<p>And now we can use npm install to install it in our node_modules directory.</p>

<pre class="code">$ npm install --no-bin-links</pre>

<p>Next, we&#8217;ll create a very basic express application in a new file. Create a file called app.js that looks like this:</p>

<pre class="code">// We need to 'require' the                                                                                                                            
// following modules                                                                                                                    
var express = require("express"),
    http = require("http"),
    path = require("path"),
    app = express();

// This is our basic configuration                                                                                                                     
app.configure(function () {
    // Define our static file directory, it will be 'public'                                                                                           
    app.use(express.static(path.join(__dirname, 'public')));
});

// Create the http server and get it to                                                                                                                
// listen on the specified port 3000                                                                                                                   
http.createServer(app).listen(3000, function(){
    console.log("Express server listening on port 3000");
});

app.get("/", function (req, res) {
    //send "Hello World" to the client as html
    res.send("Hello World!");
});</pre>

<p>Save this file and run it using Node.</p>

<pre class="code">$ node app.js</pre>

<p>You should see that Express is listening on port 3000, and now you should be able to point your browser to localhost:3000 and see &#8220;Hello World!&#8221;</p>

<p>We can specify other routes by providing other calls to the get method in the app object. For example, add the following to your code after the &#8220;Hello World&#8221; route:</p>

<pre class="code">app.get("/goodbye", function (req, res) {
    //send "Goodbye World" to the client as html
    res.send("Goodbye World!");
});

app.get("/login", function (req, res) {
    res.send("You need to login!");
});</pre>

<p>Run your server and then visit &#8220;localhost:3000/goodbye&#8221; and &#8220;localhost:3000/login&#8221; in your web browser. You should see the message associated with the route.</p>

<p>We can add any number of routes to our server, but we&#8217;re really interested in serving up static html, css and JavaScript files so that we don&#8217;t have to create long strings. To do this, we&#8217;ll create a public directory in our app folder:</p>

<pre class="code">mkdir public</pre>

<p>In our express configuration, we&#8217;ve specified that this directory will be used to serve our static content. Inside that directory, let&#8217;s make an &#8220;index.html&#8221; file with the following content.</p>

<pre class="code">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
  &lt;/head&gt;

  &lt;body&gt;
    &lt;p&gt;This is a static file!&lt;/p&gt;
    &lt;script src="http://code.jquery.com/jquery-1.9.1.min.js"&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre>

<p>We should now be able to go to &#8220;localhost:3000/index.html&#8221; in our browser and see the contents of this file displayed as HTML. Now we&#8217;ll create a route that returns JSON from our server, and we&#8217;ll have our client side JavaScript request it via Ajax. To start with, we&#8217;ll create a route that connects to redis and gets our awesomeCount out. Make sure you&#8217;ve let the twitter.js program run for a few seconds so that Redis is populated with a count.</p>

<p>Since we don&#8217;t have the Redis module included in our app.js file, let&#8217;s modify the require section of our code to look something like this:</p>

<pre class="code">var express = require("express"),
    http = require("http"),
    path = require("path"),
    redisClient = require("redis").createClient(),
    app = express();</pre>

<p>Next, add the following route to your express app:</p>

<pre class="code">app.get("/counts.json", function	(req, res) {
    redisClient.get("awesome", function	(error, awesomeCount) {
	if (error !== null) {
            // handle error here                                                                                                                       
            console.log("ERROR: " + error);
        } else {
            var jsonObject = {
		"awesome":awesomeCount
            };
            // use res.json to return JSON objects instead of strings
            res.json(jsonObject);
        }
    });
});</pre>

<p>Now if we go to &#8220;localhost:3000/counts.json&#8221; in our web browser, we should see the file as a server-generated JSON object. We&#8217;ll continue by creating a client-side JavaScript file to consume the JSON object. Inside your &#8220;public&#8221; directory, create a directory called <tt>javascripts</tt> and a file called client-app.js with the following content:</p>

<pre class="code">var main = function () {
    $.getJSON("/counts.json", function (response) {
        $("body").append("&lt;p&gt;awesome:"+response.awesome+"&lt;/p&gt;");
    });
};

$(document).ready(main);</pre>

<p>And now include that file in your index.html with a script tag, right below the jQuery script tag:</p>

<pre class="code">&lt;script src="/javascripts/client-app.js"&gt;&lt;/script&gt;</pre>

<p>After that, if you navigate your browser back to localhost:3000/index.html, you should see the number of times the word &#8220;awesome&#8221; has appeared.</p>

<p>It should now be straightforward to create any number of routes to pull data from Redis as JSON objects. If you&#8217;ve successfully used mget to pull data from Redis on the server as in the previous example, it should be relatively easy to modify the counts.json route callback to return an array of all of the counts. Do that now and have your client display all of them with jQuery.</p>
